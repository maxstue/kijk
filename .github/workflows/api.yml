name: Api ðŸš€

on:
  workflow_dispatch:
  push:
    branches: ["main"]
    paths: ["apps/api/**"]
  pull_request:
    branches: ["main", "develop"]
    paths: ["apps/api/**"]

env:
  DOTNET_VERSION: "9.0.x"

defaults:
  run:
    working-directory: ./apps/api

jobs:
  basic:
    name: "ðŸ› ï¸ Build, Lint/Format & Test"
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ–ï¸ Checkout Repository
        uses: actions/checkout@v6

      - name: ðŸ”§ Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: ðŸ“¦ Install dependencies
        run: dotnet restore "src/Api/Api.csproj"

      - name: ðŸ§± Build
        run: dotnet build "src/Api/Api.csproj" -c Release --no-restore

      - name: ðŸ§¹ Format
        run: dotnet format --verify-no-changes --verbosity detailed --exclude '**/Migrations/**'

      - name: ðŸ§ª Test
        run: dotnet test "src/Api/Api.csproj" --configuration Release --no-build

      - name: ðŸ” Audit
        run: |
          dotnet list package --vulnerable --include-transitive --format=json > list.json
          if jq -cre '.projects | .. | .severity? // empty | select(test("Critical"))' list.json; then
            echo 'Vulnerabilities found! Exiting...'
            jq . list.json
            exit 1
          else
            echo 'No vulnerabilities found!'
          fi
        continue-on-error: true
